# MCP stdio 模式测试命令

## 启动服务

```bash
python -m mcp_tool.demo_app
```

## 测试序列

### 1. Initialize - 初始化连接

```
Content-Length: 163

{"jsonrpc": "2.0", "id": "init-1", "method": "initialize", "params": {"protocolVersion": "2024-11-05", "capabilities": {}, "clientInfo": {"name": "test-client"}}}
```

**预期响应**：
```json
{
  "jsonrpc": "2.0",
  "id": "init-1",
  "result": {
    "capabilities": {"tools": true},
    "serverInfo": {"name": "notion-mcp", "version": "0.1.0"},
    "sessionId": "local"
  }
}
```

---

### 2. tools/list - 列出所有可用工具

```
Content-Length: 60

{"jsonrpc": "2.0", "id": "list-1", "method": "tools/list"}
```

**预期响应**：
```json
{
  "jsonrpc": "2.0",
  "id": "list-1",
  "result": {
    "tools": [
      {
        "name": "ping",
        "description": "简单的 ping 工具，验证 MCP 连接是否正常",
        "inputSchema": {
          "type": "object",
          "properties": {
            "message": {"type": "string"}
          }
        },
        "outputSchema": {"type": "object"}
      },
      {
        "name": "search",
        "description": "根据关键词搜索示例数据，返回文本内容",
        "inputSchema": {
          "type": "object",
          "properties": {
            "keyword": {"type": "string"}
          }
        },
        "outputSchema": {"type": "object"}
      }
    ]
  }
}
```

---

### 3. tools/call - 调用 ping 工具（默认参数）

```
Content-Length: 83

{"jsonrpc": "2.0", "id": "call-1", "method": "tools/call", "params": {"name":"ping"}}
```

**预期响应**：
```json
{
  "jsonrpc": "2.0",
  "id": "call-1",
  "result": {
    "content": [
      {"type": "text", "text": "MCP: pong"}
    ]
  }
}
```

---

### 4. tools/call - 调用 ping 工具（自定义消息）

```
Content-Length: 117

{"jsonrpc": "2.0", "id": "call-2", "method": "tools/call", "params": {"name": "ping", "arguments": {"message": "hello"}}}
```

**预期响应**：
```json
{
  "jsonrpc": "2.0",
  "id": "call-2",
  "result": {
    "content": [
      {"type": "text", "text": "MCP: hello"}
    ]
  }
}
```

---

### 5. tools/call - 调用 search 工具（无关键词，返回全部）

```
Content-Length: 86

{"jsonrpc": "2.0", "id": "call-3", "method": "tools/call", "params": {"name": "search"}}
```

**预期响应**：
```json
{
  "jsonrpc": "2.0",
  "id": "call-3",
  "result": {
    "content": [
      {
        "type": "text",
        "text": "{\"matches\": [{\"title\": \"Notion MCP\", \"summary\": \"掌握 JSON-RPC 2.0 和工具注册\"}, {\"title\": \"WebSocket\", \"summary\": \"使用 FastAPI 提供双向通讯\"}]}"
      }
    ]
  }
}
```

---

### 6. tools/call - 调用 search 工具（搜索 "notion"）

```
Content-Length: 123

{"jsonrpc": "2.0", "id": "call-4", "method": "tools/call", "params": {"name": "search", "arguments": {"keyword": "notion"}}}
```

**预期响应**：
```json
{
  "jsonrpc": "2.0",
  "id": "call-4",
  "result": {
    "content": [
      {
        "type": "text",
        "text": "{\"matches\": [{\"title\": \"Notion MCP\", \"summary\": \"掌握 JSON-RPC 2.0 和工具注册\"}]}"
      }
    ]
  }
}
```

---

### 7. tools/call - 调用 search 工具（搜索 "websocket"）

```
Content-Length: 127

{"jsonrpc": "2.0", "id": "call-5", "method": "tools/call", "params": {"name": "search", "arguments": {"keyword": "websocket"}}}
```

**预期响应**：
```json
{
  "jsonrpc": "2.0",
  "id": "call-5",
  "result": {
    "content": [
      {
        "type": "text",
        "text": "{\"matches\": [{\"title\": \"WebSocket\", \"summary\": \"使用 FastAPI 提供双向通讯\"}]}"
      }
    ]
  }
}
```

---

## 完整测试输入（一次性粘贴）

将以下内容保存为 `test_input.txt`，然后运行 `cat test_input.txt | python -m mcp_tool.demo_app`

```
Content-Length: 163

{"jsonrpc": "2.0", "id": "init-1", "method": "initialize", "params": {"protocolVersion": "2024-11-05", "capabilities": {}, "clientInfo": {"name": "test-client"}}}
Content-Length: 60

{"jsonrpc": "2.0", "id": "list-1", "method": "tools/list"}
Content-Length: 83

{"jsonrpc": "2.0", "id": "call-1", "method": "tools/call", "params": {"name": "ping"}}
Content-Length: 117

{"jsonrpc": "2.0", "id": "call-2", "method": "tools/call", "params": {"name": "ping", "arguments": {"message": "hello"}}}
Content-Length: 86

{"jsonrpc": "2.0", "id": "call-3", "method": "tools/call", "params": {"name": "search"}}
Content-Length: 123

{"jsonrpc": "2.0", "id": "call-4", "method": "tools/call", "params": {"name": "search", "arguments": {"keyword": "notion"}}}
Content-Length: 127

{"jsonrpc": "2.0", "id": "call-5", "method": "tools/call", "params": {"name": "search", "arguments": {"keyword": "websocket"}}}
```

---

## 错误测试案例

### 调用不存在的工具

```
Content-Length: 92

{"jsonrpc": "2.0", "id": "err-1", "method": "tools/call", "params": {"name": "nonexistent"}}
```

**预期响应**：
```json
{
  "jsonrpc": "2.0",
  "id": "err-1",
  "error": {
    "code": -32601,
    "message": "Tool not found: nonexistent"
  }
}
```

---

### 缺少必需的参数

```
Content-Length: 72

{"jsonrpc": "2.0", "id": "err-2", "method": "tools/call", "params": {}}
```

**预期响应**：
```json
{
  "jsonrpc": "2.0",
  "id": "err-2",
  "error": {
    "code": -32602,
    "message": "Missing 'name' for tools/call"
  }
}
```

---

## 自动化测试脚本

### test_mcp.py

```python
import subprocess
import json

def send_message(proc, request):
    """发送 JSON-RPC 消息"""
    payload = json.dumps(request, ensure_ascii=False)
    encoded = payload.encode('utf-8')
    header = f"Content-Length: {len(encoded)}\r\n\r\n"
    full_message = header.encode('utf-8') + encoded + b'\n'
    
    proc.stdin.write(full_message)
    proc.stdin.flush()
    
    # 读取响应头
    response = b""
    while b"\r\n\r\n" not in response:
        chunk = proc.stdout.read(1)
        if not chunk:
            break
        response += chunk
    
    # 解析 Content-Length
    header_text = response.decode('utf-8')
    content_length = int(header_text.split("Content-Length: ")[1].split("\r\n")[0])
    
    # 读取响应体
    body = proc.stdout.read(content_length).decode('utf-8')
    return json.loads(body)

# 启动进程
proc = subprocess.Popen(
    ['python', '-m', 'mcp_tool.demo_app'],
    stdin=subprocess.PIPE,
    stdout=subprocess.PIPE,
    stderr=subprocess.PIPE
)

try:
    # 1. Initialize
    print("=== 1. Initialize ===")
    response = send_message(proc, {
        "jsonrpc": "2.0",
        "id": "init-1",
        "method": "initialize",
        "params": {
            "protocolVersion": "2024-11-05",
            "capabilities": {},
            "clientInfo": {"name": "test-client"}
        }
    })
    print(json.dumps(response, indent=2, ensure_ascii=False))
    
    # 2. List tools
    print("\n=== 2. List Tools ===")
    response = send_message(proc, {
        "jsonrpc": "2.0",
        "id": "list-1",
        "method": "tools/list"
    })
    print(json.dumps(response, indent=2, ensure_ascii=False))
    
    # 3. Call ping
    print("\n=== 3. Call ping ===")
    response = send_message(proc, {
        "jsonrpc": "2.0",
        "id": "call-1",
        "method": "tools/call",
        "params": {"name": "ping", "arguments": {"message": "hello"}}
    })
    print(json.dumps(response, indent=2, ensure_ascii=False))
    
    # 4. Call search
    print("\n=== 4. Call search ===")
    response = send_message(proc, {
        "jsonrpc": "2.0",
        "id": "call-2",
        "method": "tools/call",
        "params": {"name": "search", "arguments": {"keyword": "notion"}}
    })
    print(json.dumps(response, indent=2, ensure_ascii=False))
    
finally:
    proc.stdin.close()
    proc.terminate()
    proc.wait()

print("\n✅ 所有测试完成！")
```

运行：
```bash
python test_mcp.py
```

---

## 注意事项

1. **Content-Length 必须精确**：包含 JSON 字节数（UTF-8 编码）
2. **格式要求**：`Content-Length: <数字>\r\n\r\n<JSON>`
3. **每条消息后需要换行**：便于流式处理
4. **中文字符**：UTF-8 编码下一个中文字符 = 3 字节，需要重新计算长度
5. **手动输入时**：按回车后需要再输入一个空行（两次回车）
